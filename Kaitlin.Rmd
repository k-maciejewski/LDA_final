---
title: "Kaitlin's EDA"
author: "Kaitlin Maciejewski"
date: "12/1/2018"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

# Exploratory

```{r load data}
library(dplyr)
data <- read.csv("../final_data/frmgham2.csv") %>% janitor::clean_names()
attach(data)

library(psych) 
knitr::kable(describe(data)[,c(2,3,4,5,8,9,10,13)], digits = 3)

library(caret)
data_2 <- select(data, -c(randid, time, period, timeap:timehyp))
featurePlot(data_2,as.factor(cursmoke),"box")

# library(GGally)
# ggpairs(data_2)

```



```{r}
# spaghetti
# lorellogram
# 

library(ggplot2)

ggplot(data= data, aes(age, cigpday)) + 
  geom_point(alpha = .6) +
  geom_smooth(method = 'lm', col = 'red') + 
  geom_smooth(method = 'loess') +
  ggtitle("cigpday vs Age Scatterplot")

ggplot(data=data, aes(age, cigpday, group = randid, color = as.factor(sex))) + 
  geom_path(alpha = .6) +
  geom_smooth(aes(group = NULL), method = 'lm', col = 'red') + 
  geom_smooth(aes(group = NULL), method = 'loess') +
  ggtitle("cigpday vs Age Spaghetti Plot")

ggplot(data=data, aes(as.factor(period), cigpday, group = randid, color = as.factor(sex))) + 
  geom_path(alpha = .6) +
  geom_smooth(aes(group = NULL), method = 'lm', col = 'red') + 
  geom_smooth(aes(group = NULL), method = 'loess') +
  ggtitle("cigpday vs time Spaghetti Plot")

### Select samples from quartiles -- doesnt work

# data.residual <- data %>% na.omit()  %>% 
# group_by(age) %>%
# mutate(mean.cigpday = mean(cigpday)) %>%
# ungroup() %>%
# mutate(residuals = cigpday - mean.cigpday) %>%
# group_by(randid) %>%
# mutate(median.residual = median(residuals)) %>%
# ungroup() 
# 
# data.stats <- c(min(data.residual$median.residual),
# quantile(data.residual$median.residual,
# c(.25, .5, .75)), max(data.residual$median.residual))
# 
# data.id.select <- data.residual %>%
# filter(median.residual %in% data.stats) 
# 
# data.residual.plot <- ggplot() +
# geom_line(data = data.id.select,
# aes(x = age, y = cigpday, group = randid)) +
# ggtitle("cigpday by time, Selected from Residuals") +
# geom_smooth(data = data,
# aes(x = age, y = cigpday))

###

ggplot(data, aes(y = cursmoke, x = age)) + geom_jitter(height = 0.1) +
stat_summary(fun.y = 'mean', geom="line", col = 'red')

select(data, -c(randid, time,timeap:timehyp)) %>% GGally::ggcorr(.)


corr <- data[,c(-1,-21)] %>% cor(., use = "complete.obs")

library(corrplot)
corrplot(corr, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 75, tl.offset = 1, tl.cex = .8, method = "ellipse")

corr2 <- data[,c(2,3,4,5,6,7,8,10,11,12,13,14)] %>% cor(., use = "complete.obs")
corrplot(corr2, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)


ggplot(data = data,
aes(x = as.factor(cursmoke), y = age)) +
geom_violin() +
  facet_wrap(~sex)

ggplot(data = data,
aes(x = cigpday, y = age)) +
geom_point() +
  facet_wrap(~sex) +
  geom_smooth()


resp.long_2 <- data
theme_set(theme_bw(base_size = 10))
##lorelogram 

lorelogram <- function(id, time, y, title){
  data <- data_frame(id,time,y)
  
  #function that innumerates all combinations of a given time
  #and all futures times for an individual and then
  #returns a dataframe of time differences and results at both time points
  calc_time_deltas <- function(ind_data){
    results <- expand.grid(ind_data$time,ind_data$time) %>%
      rename(time1 = Var1, time2 = Var2) %>%  #rename columns
      right_join(ind_data[,c("time", "y")], by = c("time1" = "time")) %>%
      rename(y1 = y) %>%  #add results for time1 from the full data
      right_join(ind_data[,c("time", "y")], by = c("time2" = "time")) %>%
      rename(y2 = y) %>%  #add results for time2 from the full data.
      mutate(time_diff = time1 - time2, id = ind_data$id[1]) %>% #find difference in times
      filter(time_diff > 0) #cleanup output.
  }
  
  Z <- data %>%
    group_by(id) %>% #grab an individuals data in isolation
    do(calc_time_deltas(.)) #run the immumeration function
  
  #Predict past outcomes from future by utilizing time differences
  outcome_model <- glm(y1 ~ y2:factor(time_diff), data=Z, family=binomial)
  
  #grab the parameter estimates (ignoring intercept)
  LOR_estimates <- data_frame(
    time_diff = sort(unique(Z$time_diff)),
    point_est = summary(outcome_model)$coef[-1,1],
    std_err = summary(outcome_model)$coef[-1,2] ) %>%
    mutate(lower_bound = point_est - 1.96*std_err,
           upper_bound = point_est + 1.96*std_err)
  
  #plot it
  ggplot(LOR_estimates, aes(x = time_diff)) +
    geom_ribbon(aes(ymin = lower_bound, ymax = upper_bound, fill = "95 % CI"),
                alpha = 0.5) +
    geom_line(aes(y = point_est, color = "point estimate")) +
    scale_colour_manual("",values="black")+
    scale_fill_manual("",values="steelblue") +
    labs(x = "time change", y = "Log Odds Ratio", title = title)
}
  
lorelogram(id = resp.long_2$randid, 
             time = resp.long_2$period,
             y = resp.long_2$cursmoke,
             title = 'Lorelogram')
```

# Models GLMER

(1) Is there a relationship between age and smoking status? Does this relationship differ by sex?
```{r}
# possible confounders of smoking status...
# education
# disease status

library(lme4)

smoke_stat_age <- glmer(cursmoke~age+educ + (1|randid), family=binomial, na.action = "na.omit")

knitr::kable(summary(smoke_stat_age)$coefficients,digits = 3)

smoke_stat_sex <- glmer(cursmoke~age+educ + as.factor(sex) + (1|randid), family=binomial, na.action = "na.omit")

knitr::kable(summary(smoke_stat_sex)$coefficients,digits = 3)
```


(2) Is there a relationship between the number of cigarettes smoked per day and age? Does this relationship differ by sex?
```{r}
cigpday_age <- glmer(cigpday~age+educ +(1|randid), family=poisson, na.action = "na.omit")

knitr::kable(summary(cigpday_age)$coefficients, digits = 3)

ncig_gee <- glmer(cigpday~age+as.factor(sex) + educ+ (1|randid), family=poisson, na.action = "na.omit")

knitr::kable(summary(ncig_gee)$coefficients,digits = 3)
```

(1) The relationship between current smoking status and systolic blood pressure. 
```{r}
smoke_sys<-glmer(cursmoke~sysbp + (1|randid), family=binomial, na.action = "na.omit") 

knitr::kable(summary(smoke_sys)$coefficients,digits = 3)

smoke_sys<-glmer(cursmoke~sysbp + as.factor(sex) + (1|randid), family=binomial, na.action = "na.omit") 

knitr::kable(summary(smoke_sys)$coefficients,digits = 3)
```

(2) The relationship between current smoking status and diastolic blood pressure. 
```{r}
smoke_dias<-glmer(cursmoke~diabp + (1|randid), family=binomial,  na.action = "na.omit")

knitr::kable(summary(smoke_dias)$coefficients,digits = 3)

smoke_dias<-glmer(cursmoke~diabp + as.factor(sex) + (1|randid), family=binomial,  na.action = "na.omit")

knitr::kable(summary(smoke_dias)$coefficients,digits = 3)
```

(3) The relationship between current smoking status and serum total cholesterol.
```{r}
smoke_chol<-glmer(cursmoke~totchol + (1|randid), family=binomial, na.action = "na.omit")

knitr::kable(summary(smoke_chol)$coefficients,digits = 3)

smoke_chol<-glmer(cursmoke~totchol + as.factor(sex) + (1|randid), family=binomial,  na.action = "na.omit")

knitr::kable(summary(smoke_chol)$coefficients,digits = 3)

###

my.data.complete <- data %>%
  dplyr::select(-c(hdlc,ldlc)) %>%
  na.omit()

model.saturated <- geepack::geeglm(formula = cursmoke ~ as.factor(sex) + 
    age + age * as.factor(sex) + sysbp + diabp + sysbp * diabp + 
    bpmeds + as.factor(educ) + totchol + bmi + glucose + diabetes + 
    heartrte + prevap + prevchd + prevmi + prevstrk + prevhyp, 
    family = binomial, data = my.data.complete, id = randid, 
    corstr = ("unstructured"))

model <- aov(model.saturated)
car::vif(model)

```

# Models GEE

(1) Is there a relationship between age and smoking status? Does this relationship differ by sex?
```{r}
smoke_stat_age <- gee::gee(cursmoke~age, id =randid, family=binomial, corstr = "unstructured", na.action = "na.omit")
knitr::kable(summary(smoke_stat_age)$coefficients[,c(1,4,5)],digits = 3)
smoke_stat_sex <- gee::gee(cursmoke~age+as.factor(sex), id =randid, family=binomial, corstr = "unstructured", na.action = "na.omit")
knitr::kable(summary(smoke_stat_sex)$coefficients[,c(1,4,5)],digits = 3)
knitr::kable(round(2*pnorm(abs(coef(summary(smoke_stat_sex))[,5]), lower.tail = FALSE), 3))
```


(2) Is there a relationship between the number of cigarettes smoked per day and age? Does this relationship differ by sex?
```{r}
cigpday_age <- gee::gee(cigpday~age, id=randid, family=poisson, corstr = "unstructured", na.action = "na.omit")
knitr::kable(summary(cigpday_age)$coefficients[,c(1,4,5)],digits = 3)
ncig_gee <- gee::gee(cigpday~age+as.factor(sex), id=randid, family=poisson, corstr = "unstructured", na.action = "na.omit")
summary(ncig_gee)
knitr::kable(summary(ncig_gee)$coefficients[,c(1,4,5)],digits = 3)
knitr::kable(round(2*pnorm(abs(coef(summary(ncig_gee))[,5]), lower.tail = FALSE),3))
```

(1) The relationship between current smoking status and systolic blood pressure. 
```{r}
smoke_sys<-gee::gee(cursmoke~sysbp, id =randid, family=binomial, corstr = "unstructured", na.action = "na.omit") 
knitr::kable(summary(smoke_sys)$coefficients[,c(1,4,5)],digits = 3)
```

(2) The relationship between current smoking status and diastolic blood pressure. 
```{r}
smoke_dias<-gee::gee(cursmoke~diabp, id =randid, family=binomial, corstr = "unstructured", na.action = "na.omit")
knitr::kable(summary(smoke_dias)$coefficients[,c(1,4,5)],digits = 3)
```

(3) The relationship between current smoking status and serum total cholesterol.
```{r}
smoke_chol<-gee::gee(cursmoke~totchol, id =randid, family=binomial, corstr = "unstructured", na.action = "na.omit")
knitr::kable(summary(smoke_chol)$coefficients[,c(1,4,5)],digits = 3)
```

#####

What to Turn In: For this assignment you will turn in a single pdf document with (a) your summary of findings and (b) an Appendix with figures and (c) an Appendix with all R code (in the form of a knited pdf).

#OBJECTIVE: 
An objective or description of the goals of the analysis 

We are interested to describe the smoking habits of the participants in the Framingham Heart study as they age and the impact of smoking on certain health outcomes. The Framingham heart study asks participants about their smoking habits at each visit. In particular, participants are asked if they are currently smoking at this visit (0 = Not a current smoker, 1 = Current smoker), which we will refer to as current smoking status. In addition, participants also report the number of cigarettes they are smoking per day. A more complete description of each of variables in the Framingham Heart study can be found in the Framingham Heart Study Longitudinal Data Documentation. 

We are interested to answer the following questions:

(1) Is there a relationship between age and smoking status? Does this relationship differ by sex?

(2) Is there a relationship between the number of cigarettes smoked per day and age? Does this relationship differ by sex?

While answering these questions, please account for any confounders that you have evidence may impact the relationship between age and sex with smoking.

Next you are interested in the relationship between certain health outcomes and smoking status. In particular you are interested in :

(1) The relationship between current smoking status and systolic blood pressure. 

(2) The relationship between current smoking status and diastolic blood pressure. 

(3) The relationship between current smoking status and serum total cholesterol.

Again, while answering these questions, please account for any confounders that you have evidence may impact these relationships.

#STUDY DESIGN: 
A brief description of the study design and the data

#METHODS: 
A methods section describing your statistical analysis (please justify all modeling choices that were made with evidence).

#RESULTS: 
A results section that includes a) descriptive statistics for the data b) a summary of your key findings including supporting numerical summaries (i.e. confidence intervals, pvalues, etc.) c) interpretations of your key findings (i.e. interpretations of coefficients).

#CONCLUSION: 
A conclusion specifically answering the objective of the analysis.

#APPENDIX: